function ELM(t){return document.getElementById(t)}function T(t,e,n){var o=$("#"+e).render(n);$("#"+t).html(o),$("[data-i18n-html]").each(function(){var e=$(this).attr("data-i18n-html");console.log("KEY="+e);var n="";try{n=$.i18n.prop(e)}catch(t){n=e}$(this).html(n)})}function C(t,e){T("content",t,e)}function E(t,e){document.getElementById(t).innerHTML=e}function HGET(t,e,n){var o=new XMLHttpRequest;o.onload=function(){200==this.status&&E(e,this.responseText),n&&n(this)},o.open("GET",t),o.responseType="text",o.send(null)}function AJAX(t,e,n){var o=new XMLHttpRequest;o.onload=function(){console.log(this),n&&n(this)},o.open("GET",t),o.send(JSON.stringify(e))}var r_home={path:"#/",on:function(){}},r_control={path:"#/control",on:function(){T("content","T_CONTROL")}},r_settings={path:"#/settings",on:function(){T("content","T_SETTINGS")}},H=Router;function GO(t){H.navigate("#"+t)}function showLoading(){show_notice("控制器加载中。。。。")}function hideLoading(){}function showError(t){show_notice(t)}function NetConfig(){var n=!1,o="192.168.244.1",i="",a=new WS,c=!1,s=!1,r=0,l=!1,d=!1,u=!1,_=0;function f(){!u||3<_||!n||(_++,v(im_search_ap),a.sendReq(M_SCAN_APLIST,0,function(t){v(im_search_ok),T("config_aplist","T_SET_APLIST",t.p),0<=e.length&&$(".cb-ap-name [n='"+e+"']").prop("checked",!0),$(".cb-ap-name").on("click",function(){$(".cb-ap-name").prop("checked",!1),$(this).prop("checked",!0),$("#in_ap_name").val($(this).attr("n")),$(".btn-add").removeClass("dn-btn-disabled"),$(".btn-add").removeAttr("disabled")}),console.log(JSON.stringify(t))}),setTimeout(f,1e4))}function h(){s&&(window.location.href="device.html?sn="+i)}function g(){!s&&d&&(m(im_check_result),v(im_ok_notice),runapi("device.lastLocal",{},function(t){if(0==t.code)if(0!=t.o_ret.length){for(var e in deviceList=t.o_ret)if(i==deviceList[e].sn)return m("["+i+"]"+im_result_ok),v(im_ok_notice_2),s=!0,void setTimeout(h,3e3);setTimeout(g,5e3)}else setTimeout(g,5e3);else setTimeout(g,5e3)},function(t){setTimeout(g,5e3)}))}function t(){$(".btn-add").on("click",function(){var t,e;n?(t=$.trim($("#in_ap_name").val()),e=$.trim($("#in_ap_pass").val()),0!=t.length?(a.sendNotify(M_SET_WIFI_PARAM,{n:t,s:e}),u=!(d=!(s=!1)),g(),$(".btn-re-config").removeAttr("disabled"),$(".btn-re-config").removeClass("dn-btn-disabled")):v(im_wifi_empty)):v(im_net_noconnect)}),$("#in_ap_name").on("input",function(){var t=$.trim($(this).val()),e=$(".btn-add");0==t.length?(e.addClass("dn-btn-disabled"),e.attr("disabled","true")):(e.removeClass("dn-btn-disabled"),e.removeAttr("disabled"))}),$("#in_ap_name").on("focus",function(){$(this).attr("placeholder",""),$("#label_ap_name").html(im_wifi_name)}),$("#in_ap_name").on("blur",function(){$(this).attr("placeholder",im_wifi_name),$("#label_ap_name").html("")}),$("#in_ap_pass").on("focus",function(){$(this).attr("placeholder",""),$("#label_ap_pass").html(im_wifi_pass)}),$("#in_ap_pass").on("blur",function(){$(this).attr("placeholder",im_wifi_pass),$("#label_ap_pass").html("")}),$(".btn-re-config").on("click",function(){console.log("重新配网"),a&&a.stop(),a=new WS,i="",u=d=n=s=c=!1,C("T_SET_NETCONFIG",{}),$("#in_ap_name").attr("placeholder",im_wifi_name),$("#in_ap_pass").attr("placeholder",im_wifi_pass),t(),$(".btn-go-center").attr("disabled","true"),$(".btn-go-center").addClass("dn-btn-disabled"),$(".btn-re-config").attr("disabled","true"),$(".btn-re-config").addClass("dn-btn-disabled"),$(".btn-add").attr("disabled","true"),$(".btn-add").addClass("dn-btn-disabled"),b()}),$(".btn-go-center").on("click",function(){h()})}this.start=function(){C("T_SET_NETCONFIG",{}),t(),b()};var e="";function m(t){$("#netconfig_device_info").html(t)}function v(t){$("#netconfig_notice_info").html(t)}function b(){c||(l||5e3<(new Date).getTime()-r&&function(){if(c)return;m(im_searching),v(im_search_notice),l=!0,$.ajax({url:"http://192.168.244.1:8080/e",type:"get",cache:!1,async:!0,timeout:5e3,complete:function(t,e){if(l=!1,r=(new Date).getTime(),"success"==e)return c=!0,m(im_device_found),console.log("HAS CONNECT TO DEVICE, START WS"),v(im_connecting),a.setNoCheck(),a.regNotify(M_DEVICE_INFO_NOTIFY,0,function(t){m(t.p.sn+" "+t.p.w+"X"+t.p.h+"["+im_online+"]"),v(""),i=t.p.sn,u=!(_=0),f()}),void a.init(o,function(){m(im_connected),v(im_communicating),console.log("WS OPEN"),n=!0},function(){console.log("WS CLOSE"),n=!1,m(im_has_offline),v(im_restart),setTimeout(function(){},3e3)});console.log("complete:"+e),c=!1}})}(),setTimeout(b,1e3))}}function getStorageItem(t){return window.localStorage.getItem(t)}function setStorageItem(t,e){window.localStorage.setItem(t,e)}function removeStorageItem(t){var e=window.localStorage;return e.removeItem(e)}function isIOS(){return 0<=navigator.userAgent.toLowerCase().indexOf("ios")}function isWeixin(){return-1!=navigator.userAgent.toLowerCase().indexOf("micromessenger")}function loadI18n(){jQuery.i18n.properties({name:"strings",path:"locales/",cache:!0,encoding:"UTF-8",mode:"both",language:getLocale(),callback:function(){try{$("[data-i18n-placeholder]").each(function(){$(this).attr("placeholder",$.i18n.prop($(this).data("i18n-placeholder")))}),$("[data-i18n-html]").each(function(){var e=$(this).data("i18n-html"),n="";try{n=$.i18n.prop(e)}catch(t){n=e}$(this).html(n)}),$("[data-i18n-text]").each(function(){var t,e=$(this).html(),n=/<(.*)>/;n.test(e)?(t=n.exec(e)[0],$(this).html(t+$.i18n.prop($(this).data("i18n-text")))):$(this).text($.i18n.prop($(this).data("i18n-text")))}),$("[data-i18n-value]").each(function(){$(this).val($.i18n.prop($(this).data("i18n-value")))})}catch(t){console.log(t)}}})}H.add(r_home),H.add(r_control),H.add(r_settings),H.init(function(){console.log(this)},function(t){console.log("Hash not found -",t)}),$(document).ready(function(){var l=getParam("l"),l1;l&&0<="zh,en,ko".indexOf(l)&&(l1=getLocale(),l1!=l&&setLocale(l)),loadI18n();try{"function"==typeof eval(web_init)&&web_init()}catch(t){}});var g_touch_startX=-1,g_touch_endX=-1,g_touch_startY=-1,g_touch_endY=-1;function ScrollAction(cb1,cb2,cb3,cb4){window.ontouchstart=function(t){return t=t.touches[0],g_touch_startY=t.clientY,g_touch_startX=t.clientX,!0},window.ontouchmove=function(t){return t=t.touches[0],g_touch_endY=t.clientY,g_touch_endX=t.clientX,!0},window.ontouchend=function(e){if(-1!=g_touch_startX&&-1!=g_touch_startY&&-1!=g_touch_endX&&-1!=g_touch_endY){var scrollTop=$(window).scrollTop(),totalHeight=$(document).height(),seeHeight=$(window).height();if(10<g_touch_endY-g_touch_startY&&"function"==typeof eval(cb1)){var scrollTop=$(window).scrollTop();return scrollTop<5&&cb1(),g_touch_startY=-1,g_touch_endY=-1,!0}if(10<g_touch_startY-g_touch_endY&&"function"==typeof eval(cb2)){var scrollTop=$(window).scrollTop(),totalHeight=$(document).height(),seeHeight=$(window).height();return totalHeight<scrollTop+seeHeight+10&&cb2(),g_touch_startY=-1,g_touch_endY=-1,!0}return 20<g_touch_startX-g_touch_endX?("function"==typeof eval(cb3)&&cb3(),g_touch_startX=-1,g_touch_endX=-1):20<g_touch_endX-g_touch_startX&&("function"==typeof eval(cb4)&&cb4(),g_touch_startX=-1,g_touch_endX=-1),!0}}}var confirm_cb=function(){};function confirm_ok(){confirm_cb(),$("#div-confirm-dialg").modal("hide")}function dn_confirm(t,e){var n;0==$("#div-confirm-dialg").length&&(n="",n+='<div id="div-confirm-dialg" class="modal fade dn-modal"  tabindex="-1" role="dialog">',n+='<div class="modal-dialog" role="document">',n+='<div class="modal-content">',n+='<div class="modal-header">',n+='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',n+='<h4 class="modal-title" id="confirm-title"></h4>',n+="</div>",n+='<div class="modal-body row">',n+='<div class="col-xs-12" id="confirm-body">',n+="</div></div>",n+='<div class="modal-footer" style="text-align: center">',n+='<button class="dn-btn-m" id="confirm-ok-btn" onclick="confirm_ok()"></button>',n+='<button class="dn-btn-m button" class="close" data-dismiss="modal">'+ib_close+"</button>",n+="</div></div></div></div>",$("body").append(n)),$("#confirm-title").html(t.title),$("#confirm-body").html(t.body),$("#confirm-ok-btn").html(t.action),$("#div-confirm-dialg").modal("show"),e&&(confirm_cb=e)}function dn_showinfo(t){var e;0==$("#div-info-dialg").length&&(e="",e+='<div id="div-info-dialg" class="modal fade dn-modal"  tabindex="-1" role="dialog">',e+='<div class="modal-dialog" role="document">',e+='<div class="modal-content">',e+='<div class="modal-header">',e+='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',e+='<h4 class="modal-title" id="showinfo-title"></h4>',e+="</div>",e+='<div class="modal-body row">',e+='<div class="col-xs-12" id="showinfo-body">',e+="</div></div>",e+='<div class="modal-footer" style="text-align: center">',e+='<button class="dn-btn-m button" class="close" data-dismiss="modal">'+ib_close+"</button>",e+="</div></div></div></div>",$("body").append(e)),$("#showinfo-title").html(t.title),$("#showinfo-body").html(t.body),$("#div-info-dialg").modal("show")}function show_notice(t){0==$("#div_alert_show").length&&$("body").append('<div id="div_alert_show" class="navbar-fixed-bottom alert alert-success" style="bottom:4rem;text-align:center;display: none"><a href="#" class="close" data-dismiss="alert">&times;</a><strong></strong><span id="alert_message" style="font-weight: bold;color: RED;font-size: 16px;"></span></div>'),$("#alert_message").html(t),$("#div_alert_show").show(),setTimeout(function(){$("#div_alert_show").hide()},5e3)}var input_cb=function(){},glo_uid,glo_token;function input_ok(){var t=$("#dialog-input-in").val();input_cb(t),$("#div-input-dialg").modal("hide")}function show_input(t,e){var n;0==$("#div-input-dialg").length&&(n="",n+='<div id="div-input-dialg" class="modal fade dn-modal"  tabindex="-1" role="dialog">',n+='<div class="modal-dialog" role="document">',n+='<div class="modal-content">',n+='<div class="modal-header">',n+='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',n+='<h4 class="modal-title" id="confirm-input-title"></h4>',n+="</div>",n+='<div class="modal-body row">',n+='<div class="col-xs-12" id="confirm-input-body"></div>',n+='<div class="col-xs-12"><input type="text" style="margin-top:1.2rem;border:1px solid #CCC" id="dialog-input-in"></div></div>',n+='<div class="modal-footer" style="text-align: center">',n+='<button class="dn-btn-m button" id="confirm-input-btn" onclick="input_ok()"></button>',n+='<button class="dn-btn-m button" class="close" data-dismiss="modal">'+ib_cancel+"</button>",n+="</div></div></div></div>",$("body").append(n)),$("#confirm-input-title").html(t.title),$("#confirm-input-body").html(t.body),$("#confirm-input-btn").html(t.action),$("#div-input-dialg").modal("show"),input_cb=e}function getBaseUrl(){return document.location.protocol+"//"+document.location.host+"/smart"}function runapi(t,e,n,o){var i="https://daniaokeji.com/led/api?_="+Math.random();console.log("RUN API:"+i+", ACTION:"+t);var a={},c=getLogin();c&&(a.uid=c.uid,a.sessionkey=c.token),a.chnl="0000",a.guid="0000",a.platform="H5",a.versionCode="12000";var s={};s.header=a,s.method=t,s.data=e,$.ajax({url:i,type:"post",cache:!1,async:!0,timeout:5e3,contentType:"",data:JSON.stringify(s),dataType:"json",success:n,error:o})}function getParam(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),n=window.location.search.substr(1).match(e);return null!=n?unescape(n[2]):null}function getLogin(){var t=window.localStorage,e=t.getItem("LOGIN_UID");return null!=e&&{uid:e,token:t.getItem("LOGIN_TOKEN")}}function setLogin(t,e){var n=window.localStorage;n.setItem("LOGIN_UID",t),n.setItem("LOGIN_TOKEN",e),n.setItem("LOGIN_TIME",(new Date).getTime())}function delCookie(t){var e=new Date;e.setTime(e.getTime()-1);var n=getCookie(t);null!=n&&(document.cookie=t+"="+n+";expires="+e.toGMTString())}function logout(){delCookie("WX_TOKEN"),clearLogin(),window.location.reload()}function clearLogin(){var t=window.localStorage;t.removeItem("LOGIN_UID"),t.removeItem("LOGIN_TOKEN"),t.removeItem("LOGIN_TIME"),t.removeItem("HOSTFACTORY")}function setLocale(t){window.localStorage.setItem("LOCALE_LANG",t)}function getLocale(){var t=window.localStorage.getItem("LOCALE_LANG");return null!=t||(null!=(t=(t=navigator.language||navigator.userLanguage).substr(0,2))&&0!=t.length||(t=isWeixin()?"zh":"en"),-1=="zh,en,ko".indexOf(t)&&(t="en")),t}function getCookie(t){return 0<document.cookie.length&&(c_start=document.cookie.indexOf(t+"="),-1!=c_start)?(c_start=c_start+t.length+1,c_end=document.cookie.indexOf(";",c_start),-1==c_end&&(c_end=document.cookie.length),unescape(document.cookie.substring(c_start,c_end))):null}function setCookie(t,e,n){var o=new Date;o.setTime(o.getTime()+n),document.cookie=t+"="+escape(e)+";expires="+o.toGMTString()}function buff2Base64(t){for(var e,n="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(t),a=i.byteLength,c=a%3,s=a-c,r=0;r<s;r+=3)n+=o[(16515072&(e=i[r]<<16|i[r+1]<<8|i[r+2]))>>18]+o[(258048&e)>>12]+o[(4032&e)>>6]+o[63&e];return 1==c?n+=o[(252&(e=i[s]))>>2]+o[(3&e)<<4]+"==":2==c&&(n+=o[(16128&(e=i[s]<<8|i[1+s]))>>8]+o[(1008&e)>>4]+o[(15&e)<<2]+"="),n}function RGB2HEX(t,e,n){return("#"+((256+t<<8|e)<<8|n).toString(16).slice(1)).toUpperCase()}function getPosition(t){for(var e=t.offsetLeft,n=t.offsetTop,o=t.offsetParent;null!=o;)e+=o.offsetLeft,n+=o.offsetTop,o=o.offsetParent;return{left:e,top:n}}function toThousands(t){for(var t=(t||0).toString(),e=/\d{3}$/,n="";e.test(t);){if(n=RegExp.lastMatch+n,t===RegExp.lastMatch){t="";break}n=","+n,t=RegExp.leftContext}return t&&(n=t+n),n}function num2Fix(t,e){for(var n=(t||0).toString(),o=e-n.length,i=0;i<o;i++)n="0"+n;return n}function dateFormat(t,e){var n,o={"Y+":e.getFullYear().toString(),"m+":(e.getMonth()+1).toString(),"d+":e.getDate().toString(),"H+":e.getHours().toString(),"M+":e.getMinutes().toString(),"S+":e.getSeconds().toString()};for(var i in o)(n=new RegExp("("+i+")").exec(t))&&(t=t.replace(n[1],1==n[1].length?o[i]:o[i].padStart(n[1].length,"0")));return t}function RGB2HEX(t,e,n){return("#"+((256+t<<8|e)<<8|n).toString(16).slice(1)).toUpperCase()}function colorRgb(t){var e=t.toLowerCase();if(0==e.indexOf("rgb")){var n=e.split("(")[1].split(",");return{r:parseInt(n[0]),g:parseInt(n[1]),b:parseInt(n[2])}}if(e&&/^#([0-9a-fA-f]{6})$/.test(e)){for(var o=[],i=1;i<7;i+=2)o.push(parseInt("0x"+e.slice(i,i+2)));return{r:o[0],g:o[1],b:o[2]}}return null}function randomInt(t){return Math.floor(Math.random()*t+1)}function DoodingShow(){var v,b,p,w,E,I=0,n=!0,c=!0,s={hex:"#FF0000",r:255,g:0,b:0},S=new AutoColor,e=0,o=!1,i=!1;function M(){if(i){if(o)return ws.sendBytes(w),o=!1,e=(new Date).getTime(),void setTimeout(M,100);var t=(new Date).getTime();1e3<t-e&&(ws.sendBytes(w),e=t),setTimeout(M,100)}}function a(t,e){t<0||b<t||e<0||v<e||(n?function(t,e){var n=u(t,e);if(null==n)return;if(c){if(n.x==l.x&&n.y==l.y)return;!function(){var t=S.getNextColor();s.hex=RGB2HEX(t.r,t.g,t.b),s.r=t.r,s.g=t.g,s.b=t.b,$("#div-color-bar").css("background-color",s.hex)}()}var o=(l=n).x*I+10+.5*I,i=n.y*I+10+.5*I;E.beginPath(),E.arc(o,i,.3*I,0,2*Math.PI),E.closePath(),E.fillStyle=s.hex,E.fill();var a=3*(deviceInfo.w*n.y+n.x);w[a]=s.r,w[1+a]=s.g,w[2+a]=s.b,d()}:function(t,e){var n=u(t,e);if(null==n)return;var o=n.x*I+10+.5*I,i=n.y*I+10+.5*I;E.beginPath(),E.arc(o,i,.4*I,0,2*Math.PI),E.closePath(),E.fillStyle="#000000",E.fill();var a=3*(deviceInfo.w*n.y+n.x);w[a]=0,w[1+a]=0,w[2+a]=0,d()})(t,e)}function r(t){1==t?(n=!0,$("#btn_dooding").css("color","#2CA3D5"),$("#btn_eraser").css("color","#000000")):($("#btn_dooding").css("color","#000000"),$("#btn_eraser").css("color","#2CA3D5"),n=!1)}this.isRunning=function(){return i},this.start=function(){i=!0,function(){T("device_biz","T_DEVICE_DOODING",{}),p=new ArrayBuffer(deviceInfo.w*deviceInfo.h*3),w=new Uint8Array(p);var t=$(window).height(),e=$("#div_dooding_container").offset().left,n=$("#div_dooding_container").offset().top,o=t-n,i=$(window).width();$("#div_dooding_container").height(o);var a=i-10,c=o-10;$("#div_dooding").width(a),$("#div_dooding").height(c);var s=deviceInfo.w,r=deviceInfo.h,l=a/s,d=c/r,u=d<=l?d:l,_=((v=r*u)-20)/r;(I=((b=s*u)-20)/s)>_&&(I=_);console.log("STEP:"+I),b=I*s+20,v=I*r+20,$("#cav_bg").width(b),$("#cav_bg").height(v),$("#cav_bg").css("left",(a-b)/2),$("#cav_bg").css("top",(c-v)/2),$("#cav_bg").css("background-color","#000000"),$("#cav_dooding").width(b),$("#cav_dooding").height(v),$("#cav_dooding").css("left",(a-b)/2),$("#cav_dooding").css("top",(c-v)/2);var f=document.getElementById("cav_bg"),h=f.getContext("2d"),g=document.getElementById("cav_dooding");E=g.getContext("2d"),f.width=b,f.height=v,h.lineWidth=1,h.strokeStyle="#444444",g.width=b,g.height=v;for(var m=0;m<=r;m++){n=m*I+10;h.beginPath(),h.moveTo(10,n),h.lineTo(b-10,n),h.closePath(),h.stroke()}for(m=0;m<=s;m++){e=m*I+10;h.beginPath(),h.moveTo(e,10),h.lineTo(e,v-10),h.closePath(),h.stroke()}ws.sendNotify(M_START_TRANSFER_FRAME,0),setTimeout(M,100),S.start(10)}(),function(){var n=document.getElementById("cav_dooding");n.ontouchstart=function(t){t.stopPropagation();var e=t.targetTouches[0];a(e.clientX-_(n).left,e.clientY-_(n).top)},n.ontouchmove=function(t){t.stopPropagation(),t.preventDefault();var e=t.targetTouches[0];a(e.clientX-_(n).left,e.clientY-_(n).top)};var e=!1;window.onmousedown=function(t){e=!0},n.onmousedown=function(t){e=!0,a(t.clientX-_(n).left,t.clientY-_(n).top)},n.onmousemove=function(t){e&&a(t.clientX-_(n).left,t.clientY-_(n).top)},window.onmouseup=function(){e=!1},$(".btn-dooding").on("click",function(){r($(this).attr("p"))}),$(".btn-clear").on("click",function(){for(var t in E.clearRect(0,0,b,v),r(1),w)w[t]=0;d()}),$(".btn-color").on("click",function(){(new ColorChooser).startSelect("select-color-model","choose-color-model",function(t){"0"==t.hex?(c=!0,S.start(10)):(c=!1,s.hex=t.hex,s.r=t.r,s.g=t.g,s.b=t.b,$("#div-color-bar").css("background-color",s.hex))})})}()},this.stop=function(){i=!1,ws.sendNotify(M_END_TRANSFER_FRAME,0),S.stopAuto()};var l={x:-1,y:-1};function d(){o=!0}function u(t,e){var n={};return n.x=Math.floor((t-10)/I),n.y=Math.floor((e-10)/I),n.x>=deviceInfo.w||n.y>=deviceInfo.h||n.x<0||n.y<0?null:n}function _(t){for(var e=t.offsetLeft,n=t.offsetTop,o=t.offsetParent;null!=o;)e+=o.offsetLeft,n+=o.offsetTop,o=o.offsetParent;return{left:e,top:n}}}function WS(){var n,o,i,a,c=0,s=[],r=0,l="",e=!0;function d(){(n=new WebSocket(o)).onopen=function(t){!function(){console.log("WS: onopen"),c=(new Date).getTime(),isOnline=!0,console.log(i),i&&i();e&&(u(),_())}()},n.onclose=function(t){console.log("WS: onclose"),n=null,isOnline=!1,setTimeout(function(){console.log("reconnect to device"),n&&1==n.readyState&&(n.close(),n=null),d()},3e3),a&&a()},n.onmessage=function(t){!function(t){c=(new Date).getTime();var e=JSON.parse(t.data);e&&e.m&&function(t){for(var e=0;e<s.length;e++){var n=s[e];if(t.m==n.m&&(0==n.cn||t.on==n.cn)){n.cb(t),s.slice(e,1);break}}}(e)}(t)},n.onerror=function(t){console.log("WS: onerror")}}function u(){(new Date).getTime()-c<1e4?setTimeout(u,1e3):$.ajax({url:l,type:"get",cache:!1,async:!0,timeout:5e3,error:function(t){console.log("AJAX IDLE ERROR:"+t)},complete:function(t,e){"success"==e?c=(new Date).getTime():console.log("AJAX STATUS:"+e),setTimeout(u,5e3)}})}function _(){if(n&&1==n.readyState){if((new Date).getTime()-c<3e4)return void setTimeout(_,1e3);a&&a(),console.log("CHECK TIME OUT:30 seconds"),n.close()}}function f(t){if(n&&1==n.readyState&&t instanceof Object){var e=JSON.stringify(t);console.log("SEND:"+e);try{n.send(e)}catch(t){console.log("SEND FAILED:"+t)}(new Date).getTime()}}this.init=function(t,e,n){isOnline=!1,this.ip=t,o="ws://"+t+":8080/ws",l="http://"+t+":8080/e",i=e,a=n,d()},this.setNoCheck=function(){e=!1},this.stop=function(){e=!1,n&&n.close()},this.sendReq=function(t,e,n){f({m:t,p:e,cn:r}),n&&s.push({cn:r,m:t,cb:n}),r++},this.regNotify=function(t,e,n){n&&s.push({cn:e,m:t,cb:n})},this.sendRes=function(t,e,n,o){f({m:t,p:e,cn:r,on:n,rc:o})},this.sendNotify=function(t,e){f({m:t,p:e})},this.sendBytes=function(t){n&&1==n.readyState&&(console.log("SEND FRAME:"+t.length),n.send(t),(new Date).getTime())}}var M_DEV_AUTH_LOGIN=101,M_SET_AUTHTOK=102,M_SET_CLOUDLINK=103,M_SCAN_APLIST=201,M_SET_WIFI_PARAM=202,M_GET_WIFI_PARAM=203,M_CLEAR_WIFI_PARAM=204,M_GET_NET_DETAIL=205,M_DEVICE_INFO_NOTIFY=301,M_GET_LAYOUT=302,M_SET_LAYOUT_DIR=303,M_SET_DEVICE_NAME=304,M_IDLE=305,M_SET_COLOR=401,M_PLAY_NEXT=402,M_PLAY_PREV=403,M_PLAY_EFFECT=404,M_SET_MODE_LOOP=405,M_SET_MODE_SINGLE=406,M_SET_BRIGHTNESS=407,M_SET_POWERON=408,M_SET_POWEROFF=409,M_START_TRANSFER_FRAME=410,M_END_TRANSFER_FRAME=411,M_LOCK_FRAME=412,M_SET_E131_PARAM=413,M_GET_E131_PARAM=414,M_PLAY_INFO_NOTIFY=501,M_ADD_PLAYLIST=502,M_REMOVE_PLAYLIST=503,M_GET_PLAYLIST=504,M_START_INSTALL_EFFECT=505,M_END_INSTALL_EFFECT=506,M_REMOVE_EFFECT=507,M_GET_EFFECT_LIST=508,M_GET_EFFECT_DETAIL=509,M_SEARCH_EFFECT=510,M_BOOKMARK_EFFECT=511,M_BOOKMARK_REMOVE=512,M_BOOKMARK_LIST=513,M_ENABLE_BOOKMARK_PLAY=514,M_DISABLE_BOOKMARK_PLAY=515,M_ADD_TIMER=601,M_REMOVE_TIMER=602,M_GET_TIMER_LIST=603,M_ENABLE_TIMER=604,M_DISABLE_TIMER=605,M_SYNC_TIME_INFO=606,M_SET_AUTO_TIMER_POLICY=607,M_START_UPDATE_FIRMWARE=701,M_END_UPDATE_FIRMWARE=702,M_START_INSTALL_EFFECTS=703,M_END_INSTALL_EFFECTS=704,M_UPDATE_LAYOUT=705,M_SET_PLAY_SPEED=706,M_GET_PLAY_SPEED=707,M_SET_OUTPUT_PWM=708,M_GET_OUTPUT_PWM=709,M_SEARCH_EFFECTS=710,M_SEARCH_FIRMWARES=711,M_REBOOT=799,deviceList=[];function show_device_list(){showLoading();var o=!(deviceList=[]),t=getStorageItem("DeviceList");if(t&&(deviceList=JSON.parse(t))&&0<deviceList.length){for(var e in deviceList){var n=deviceList[e].name;n&&0!=n.length&&"--"!=n||(deviceList[e].name=deviceList[e].sn),deviceList[e].lasttime=dateFormat("YYYY-mm-dd HH:MM",new Date(deviceList[e].online))}C("T_DEVICE_LIST",{list:deviceList}),o=!0}runapi("device.lastLocal",{},function(t){if(show_notice(im_loaddevice_over),0==t.code)if(0!=t.o_ret.length){for(var e in deviceList=t.o_ret){var n=deviceList[e].name;n&&0!=n.length&&"--"!=n||(deviceList[e].name=deviceList[e].sn),deviceList[e].lasttime=dateFormat("YYYY-mm-dd HH:MM",new Date(deviceList[e].online))}setStorageItem("DeviceList",JSON.stringify(deviceList)),C("T_DEVICE_LIST",{list:deviceList})}else o||C("T_NO_DEVICE",{});else show_notice(im_error_loaddevice)},function(t){show_notice(im_error_loaddevice)})}function add_new_device(){window.location.href="http://"+document.location.host+"/smart/setting.html"}function show_language(){$("#language-dial").modal("show")}function set_Lang(t){getLocale()!=t&&(setLocale(t),loadI18n())}function go_center(t){var e="http://"+document.location.host+"/smart/device.html?sn="+t+"&l="+getLocale();window.location.href=e}function ColorChooser(){var I,S,M,n=!1,A=!1,y={r:80,g:80,b:80},C=!1;this.startChoose=function(t,e){I=e,$("#"+t).modal("show"),n||(function(){var t=180,a=document.getElementById("col-panel-canvas"),e=a.getContext("2d"),n=e.createImageData(360,360);S=n.data;for(var o=0;o<n.data.length;o+=4)n.data[o+0]=0,n.data[o+1]=0,n.data[o+2]=0,n.data[o+3]=255;for(o=0;o<360;o+=.1){var i=255,c=255,s=255;o<60?(c=parseInt(255*o/60),s=0):o<120?(i=255-parseInt(255*(o-60)/60),s=0):o<180?(i=0,s=parseInt(255*(o-120)/60)):o<240?(i=0,c=255-parseInt(255*(o-180)/60)):o<300?(i=parseInt(255*(o-240)/60),c=0):(c=0,s=255-parseInt(255*(o-300)/60));for(var r=3.1415926*o/180,l=t;0<l;l--){var d=t+parseInt(l*Math.cos(r)),u=t-parseInt(l*Math.sin(r)),_=4*(d+360*u),f=i,h=s,g=c;f=i+(255-i)/t*(t-l),g=c+(255-c)/t*(t-l),h=s+(255-c)/t*(t-l),n.data[_+0]=f,n.data[_+1]=g,n.data[_+2]=h,n.data[_+3]=255}}e.putImageData(n,0,0);var m=document.getElementById("col-gray-canvas"),v=m.getContext("2d"),b=v.createImageData(256,10);M=b.data;for(o=0;o<10;o++)for(var p=0;p<256;p++){var _=4*(256*o+p),T=255-p;b.data[_+0]=T,b.data[_+1]=T,b.data[_+2]=T,b.data[_+3]=255}function w(t){var e,n,o=parseInt(1.2*(t.clientX-getPosition(a).left)),i=parseInt(1.2*(t.clientY-getPosition(a).top));360<o||360<i||o<0||i<0||(e=4*(360*i+o),y.r=S[e],y.g=S[1+e],y.b=S[2+e],n=RGB2HEX(S[e],S[1+e],S[2+e]),$("#col-pan-sel").css("background-color",n),$("#col-sel-val").val(n))}function E(t){var e=parseInt((t.clientX-getPosition(m).left)*(256/300));e<0&&(e=0),256<e&&(e=256),y.r=M[4*e],y.g=M[4*e+1],y.b=M[4*e+2];var n=RGB2HEX(y.r,y.g,y.b);$("#col-pan-sel").css("background-color",n),$("#col-sel-val").val(n)}v.putImageData(b,0,0),a.ontouchstart=function(t){t.stopPropagation(),t=t.touches[0],A=!0,w(t)},a.onmousedown=function(t){indrag=!0,A=!0,w(t)},m.ontouchstart=function(t){t.stopPropagation(),t=t.touches[0],C=!0,E(t)},m.onmousedown=function(t){C=!0,E(t)},m.ontouchstart=function(t){t.stopPropagation(),t=t.touches[0],C=!0,E(t)},window.ontouchmove=function(t){t.stopPropagation(),t=t.touches[0],A&&w(t),C&&E(t)},window.ontouchend=function(t){if(A){for(var e=[],n=0;n<256;n++){var o={};o.r=y.r,o.g=y.g,o.b=y.b,n<128?(o.r=255-n*(255-o.r)/127,o.g=255-n*(255-o.g)/127,o.b=255-n*(255-o.b)/127):(o.r=o.r-(n-128)*o.r/127,o.g=o.g-(n-128)*o.g/127,o.b=o.b-(n-128)*o.b/127),e[e.length]=o}var i=v.createImageData(256,10);M=i.data;for(var a=0;a<10;a++)for(var c=0;c<256;c++){var s=4*(256*a+c);i.data[0+s]=e[c].r,i.data[1+s]=e[c].g,i.data[2+s]=e[c].b,i.data[3+s]=255}v.putImageData(i,0,0)}var r;(A||C)&&(r=RGB2HEX(y.r,y.g,y.b),I({hex:r,r:y.r,g:y.g,b:y.b})),C=A=!1}}(),n=!0)},this.startSelect=function(n,t,e){var o=this;I=e,$("#"+n).modal("show"),$(".btn_select_color").on("click",function(){var t=colorRgb($(this).css("background-color")),e=RGB2HEX(t.r,t.g,t.b);I({hex:e,r:t.r,g:t.g,b:t.b}),$("#"+n).modal("hide")}),$(".btn_select_auto_color").on("click",function(){I({hex:"0",r:-1,g:-1,b:-1}),$("#"+n).modal("hide")}),$(".btn_select_choose").on("click",function(){$("#"+n).modal("hide"),o.startChoose(t,e)})}}function AutoColor(){var s=0,r=0,l=0,d=0,u=0,_=0,f=0,h=0,g=0,m=10,v=0,b=!1,p=0;function T(t,e){var n=Math.floor(Math.random()*e+1);return n<t&&(n=t),e<n&&(n=e),n}this.startAuto=function(t,e,n){0!=p&&clearTimeout(p),b=!0,m=t,s=T(20,255),u=T(20,255),l=T(20,255),r=T(20,255),_=T(20,255),d=T(20,255),g=(_-u)/m,h=(d-l)/m,f=(r-s)/m,function t(e,n){if(!b)return;-1!=v&&v!=m||(s=r,l=d,u=_,r=T(20,255),_=T(20,255),d=T(20,255),g=(_-u)/m,h=(d-l)/m,f=(r-s)/m,v=0);var o=parseInt(s+f*v);var i=parseInt(l+h*v);var a=parseInt(u+g*v);o<20&&(o=20);255<o&&(o=255);i<20&&(i=20);255<i&&(i=255);a<20&&(a=20);255<a&&(a=255);v++;var c=RGB2HEX(o,i,a);n({hex:c,r:o,g:i,b:a});p=setTimeout(function(){t(e,n)},e)}(e,n)},this.stopAuto=function(){b=!1,0<p&&clearTimeout(p),p=0},this.start=function(t){m=t,s=T(20,255),u=T(20,255),l=T(20,255),r=T(20,255),_=T(20,255),d=T(20,255),g=(_-u)/m,h=(d-l)/m,f=(r-s)/m},this.getNextColor=function(){-1!=v&&v!=m||(s=r,l=d,u=_,r=T(20,255),_=T(20,255),d=T(20,255),g=(_-u)/m,h=(d-l)/m,f=(r-s)/m,v=0);var t=parseInt(s+f*v),e=parseInt(l+h*v),n=parseInt(u+g*v);return t<20&&(t=20),255<t&&(t=255),e<20&&(e=20),255<e&&(e=255),n<20&&(n=20),255<n&&(n=255),v++,{r:t,g:e,b:n}}}function DeviceHome(){var t,a=!1,c=!1,i={r:255,g:0,b:0},e=!0;function n(){e&&($(".btn-ctrl").on("click",function(){console.log("btbaidun-ctrl click"),musicShow.stop(),doodingShow.stop(),T("device_biz","T_DEVICE_CONTROL",{}),n()}),$(".btn-clear-net").on("click",function(){if(a){if(!confirm(im_clear_confirm))return;ws.sendNotify(M_CLEAR_WIFI_PARAM,0),show_notice(im_clean_ed)}}),$(".img-device-home,.btn-home").on("click",function(){$(".btn-home").addClass("dn-btn-disabled"),$(".btn-clear-net").removeClass("dn-btn-disabled"),$(".btn-maintain").removeClass("dn-btn-disabled"),console.log("img-device-home click"),musicShow.stop(),doodingShow.stop(),T("device_biz","T_DEVICE_CONTROL",{}),n()}),$(".btn-login-psk").on("click",function(){var e=$("#in-login-psk").val();e.length<6||10<e.length?$("#device-login-notice").html(im_pass_bad_len):ws.sendReq(M_DEV_AUTH_LOGIN,{pin:e},function(t){0!=t.rc?$("#device-login-notice").html(im_pass_err):(setStorageItem("PSK_"+deviceInfo.sn,e),$("#device_login_modal").modal("hide"))})}),e=!1),$(".btn-dooding").on("click",function(){$(".btn-home").removeClass("dn-btn-disabled"),$(".btn-clear-net").addClass("dn-btn-disabled"),$(".btn-maintain").addClass("dn-btn-disabled"),doodingShow.start()}),$(".btn-music").on("click",function(){$(".btn-home").removeClass("dn-btn-disabled"),$(".btn-clear-net").addClass("dn-btn-disabled"),$(".btn-maintain").addClass("dn-btn-disabled"),musicShow.start()}),$(".btn-maintain").on("click",function(){window.location.href="http://"+deviceInfo.ip+":8080/"}),$(".btn-op").on("click",function(){var t=$(this).attr("mid"),e=$(this).attr("p");ws.sendNotify(t,e)}),$(".btn-power").on("click",function(){c?ws.sendNotify(M_SET_POWEROFF,0):ws.sendNotify(M_SET_POWERON,0),c=!c,s()}),$(".cb_huxideng").on("click",function(){var t=0;$(this).prop("checked")?t=1:0,ws.sendNotify(M_SET_COLOR,{r:i.r,g:i.g,b:i.b,m:t})}),$(".btn-auto-color").on("click",function(){ws.sendNotify(M_SET_COLOR,{r:0,g:0,b:0,m:2})}),$(".btn-choose-color").on("click",function(){(new ColorChooser).startChoose("choose-color-model",function(t){o(t.r,t.g,t.b)})}),$(".btn-color").on("click",function(){o($(this).attr("r"),$(this).attr("g"),$(this).attr("b"))})}function o(t,e,n){i.r=t,i.g=e,i.b=n;var o=0;$("#cb_huxideng").prop("checked")&&(o=1),ws.sendNotify(M_SET_COLOR,{r:t,g:e,b:n,m:o})}function s(){c?$("#div_power").css("background","url('images/poweroff.png') no-repeat center"):$("#div_power").css("background","url('images/poweron.png') no-repeat center"),$("#div_power").css("background-size","45px")}function r(){$("#device_login_modal").modal("show")}function l(t){t?($("#device_status").html("["+im_status_online+"]"),$("#device_status").css("color","#008000"),$(".btn_dev").removeClass("dn-btn-disabled"),$(".btn_dev").removeAttr("disabled")):($("#device_status").html("["+im_status_offline+"]"),$("#device_status").css("color","#800000"),$(".btn_dev").addClass("dn-btn-disabled"),$(".btn_dev").attr("disabled","true"))}this.start=function(){t=getParam("sn"),ws.regNotify(M_DEVICE_INFO_NOTIFY,0,function(t){(new Date).getTime(),a=!0,console.log(JSON.stringify(t.p)),deviceInfo.ip=t.p.local,deviceInfo.w=t.p.w,deviceInfo.h=t.p.h;var e=t.p.name;e&&0!=e.length||(e=deviceInfo.name),e&&0!=e.length&&"--"!=e||(e=deviceInfo.sn),deviceInfo.name=e,$("#device_name").html(deviceInfo.name),$("#device_ip").html(deviceInfo.ip),$("#device_size").html(deviceInfo.w+"X"+deviceInfo.h),c=1==t.p.power;var n,o=t.p.security,i=t.p.login;o&&0==i&&((n=getStorageItem("PSK_"+deviceInfo.sn))&&5<n.length?ws.sendReq(M_DEV_AUTH_LOGIN,{pin:n},function(t){0!=t.rc&&(removeStorageItem("PSK_"+deviceInfo.sn),r())}):r()),t.p&&s()}),deviceInfo&&deviceInfo.w||runapi("device.info",{sn:t},function(t){var e;0==t.code?(deviceInfo=t.o_ret,(e=deviceInfo.name)&&0!=e.length&&"--"!=e||(deviceInfo.name=deviceInfo.sn),C("T_DEVICE_INFO",deviceInfo),T("device_biz","T_DEVICE_CONTROL",{}),n(),l(!1),ws.init(deviceInfo.ip,function(){console.log("callback open"),l(!0),(musicShow.isRunning()||doodingShow.isRunning())&&ws.sendNotify(M_START_TRANSFER_FRAME,0)},function(){console.log("callback close"),l(!1)})):show_notice(im_error_loaddevice)},function(){show_notice(im_error_loaddevice)})}}function MusicShow(){var b,p,w,E,I,S,M,A,y,C,i,L=0,s={hex:"#FF0000",r:255,g:0,b:0},O=new AutoColor,R=[],r=!1,a=!1,l=!1,e=0,N=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,d=!1;function k(){if(d){if(l)return ws.sendBytes(E),l=!1,e=(new Date).getTime(),void setTimeout(k,100);var t=(new Date).getTime();1e3<t-e&&(ws.sendBytes(E),e=t),setTimeout(k,100)}}function x(t){s.hex=t.hex,s.r=t.r,s.g=t.g,s.b=t.b,$("#div-color-bar").css("background-color",t.hex),S.setColor(t.r,t.g,t.b)}function D(){if(d)if(r){var t=y.frequencyBinCount,e=new Uint8Array(t);y.getByteFrequencyData(e);(new Date).getTime();S.makeShow(e),l=!0,M.clearRect(0,0,p,b);for(var n=0;n<deviceInfo.h;n++)for(var o=0;o<deviceInfo.w;o++){var i,a,c=o+n*deviceInfo.w;1==I[c]&&(i=o*L+10+.5*L,a=n*L+10+.5*L,M.beginPath(),M.arc(i,a,.3*L,0,2*Math.PI),M.closePath(),M.fillStyle=s.hex,M.fill())}setTimeout(D,100)}else setTimeout(D,1e3)}this.isRunning=function(){return d},this.start=function(){d=!0,function(){if(!N)return alert("您的浏览器不支持audio API，请更换浏览器（chrome、firefox）再尝试");T("device_biz","T_DEVICE_MUSIC",{}),null!=A&&A.resume();A=null,A=new N,y=A.createAnalyser(),C=A.createGain(),w=new ArrayBuffer(deviceInfo.w*deviceInfo.h*3),E=new Uint8Array(w),I=[];var t=$(window).height(),e=$("#div_music_container").offset().left,n=$("#div_music_container").offset().top,o=t-n,i=$(window).width();$("#div_music_container").height(o);var a=i-10,c=o-10,s=deviceInfo.w,r=deviceInfo.h,l=a/s,d=c/r,u=d<=l?d:l,_=((b=r*u)-20)/r;(L=((p=s*u)-20)/s)>_&&(L=_);p=L*s+20,b=L*r+20,$("#cav_bg").width(p),$("#cav_bg").height(b),$("#cav_bg").css("left",(a-p)/2),$("#cav_bg").css("top",(c-b)/2),$("#cav_bg").css("background-color","#000000"),$("#cav_music").width(p),$("#cav_music").height(b),$("#cav_music").css("left",(a-p)/2),$("#cav_music").css("top",(c-b)/2);var f=document.getElementById("cav_bg"),h=f.getContext("2d");f.width=p,f.height=b,h.lineWidth=1,h.strokeStyle="#444444";var g=document.getElementById("cav_music");M=g.getContext("2d"),g.width=p,g.height=b;for(var m=0;m<=r;m++){n=m*L+10;h.beginPath(),h.moveTo(10,n),h.lineTo(p-10,n),h.closePath(),h.stroke()}for(m=0;m<=s;m++){e=m*L+10;h.beginPath(),h.moveTo(e,10),h.lineTo(e,b-10),h.closePath(),h.stroke()}var v=new BaseEffect;v.init(deviceInfo.w,deviceInfo.h,I,E),R.push(v),S=v,ws.sendNotify(M_START_TRANSFER_FRAME,0),k(),O.startAuto(10,500,function(t){x(t)}),D()}(),$(".music_color").on("click",function(){(new ColorChooser).startSelect("select-color-model","choose-color-model",function(t){"0"==t.hex?O.startAuto(10,500,function(t){x(t)}):(O.stopAuto(),x(t))})}),$(".music-file").on("change",function(){i&&i.stop(),0!=this.files.length&&Array.prototype.slice.call(this.files).forEach(function(t){var e=new FileReader;e.readAsArrayBuffer(t);var o={name:t.name.substring(0,t.name.lastIndexOf(".")),buffer:null,decoding:!0};e.onload=function(t){var e,n;e=t.target.result,n=function(t){var e;o.buffer=t,e=t,a=!(r=!0),$("#btn_play").removeClass("dn-btn-disabled"),$("#btn_play").removeAttr("disabled"),$("#btn_play").html(btn_pause),(i=A.createBufferSource()).buffer=e,i.onended=function(){a=!(r=!1),$("#btn_play").addClass("dn-btn-disabled"),$("#btn_play").attr("disabled","true"),$("#btn_play").html(btn_play),i.stop(),i=null,console.log("ended...")},i.start(),i.connect(y),y.connect(C),C.connect(A.destination),o.decoding=!1},A.decodeAudioData(e,function(t){n(t)},function(t){alert("OPEN FILE ERROR")})}})}),$("#btn_play").on("click",function(){r&&(a?(a=!1,$("#btn_play").html(btn_pause),A.resume()):(a=!0,$("#btn_play").html(btn_play),A.suspend()))}),$(".btn-music-file").on("click",function(){$(".music-file").click()})},this.stop=function(){d=!1,ws.sendNotify(M_END_TRANSFER_FRAME,0),i&&i.stop(),r&&(r=!1,A.resume(),A.close()),A=null,O.stopAuto()}}function BaseEffect(){var r,l,d,u=0,_=0,f=1,h={r:255,g:0,b:0};this.init=function(t,e,n,o){r=n,l=o,d=[],f=(_=e)/255,step=1024/(u=t);for(var i=0;i<t;i++)d[i]=5},this.makeShow=function(t){for(var e=1024/u,n=0;n<u;n++){var o=t[parseInt(n*e)],i=parseInt(o*f);d[n]=i,d[n]<1&&(d[n]=1)}for(var a=0;a<u;a++){i=_-d[a];for(y=0;y<_;y++){var c=a+y*u,s=3*(a+y*u);y<i?(r[c]=0,l[s]=0,l[1+s]=0,l[2+s]=0):(r[c]=1,l[s]=h.r,l[1+s]=h.g,l[2+s]=h.b)}}},this.setColor=function(t,e,n){h.r=t,h.g=e,h.b=n}}